;;; test-colloids.dai -- Sample file demonstrating the use of colloids.

(description "Simulation of colloids.")

;; Use standard parameterizations.
(input file "tillage.dai")
(input file "crop.dai")
(input file "log.dai")


;; (input file "chemistry.dai")

(defchemical solid default
  "Non-dissolvable chemicals"
  (crop_uptake_reflection_factor 1 [])
  (canopy_dissipation_rate 0 [h^-1])
  (canopy_washoff_coefficient 1 [])
  (diffusion_coefficient 1 [cm^2/s])
  (adsorption full)
  (decompose_rate 0 [h^-1]))
  
(defchemical common default
  "For chemicals where we know no better."
  (canopy_dissipation_rate 0.0083 [h^-1])
  (canopy_washoff_coefficient 1.0 [])
  (crop_uptake_reflection_factor 1 [])
  (diffusion_coefficient 4.6e-6 [cm^2/s]))

(defchemical colloid common
  "Mobile colloids."
  ;; DOM (Hinedi et al, 1997)
  (diffusion_coefficient 6.75e-6 [cm^2/s])
  (decompose_rate 0 [h^-1]))

(defchemical colloid-filtered solid
  "Once mobile colloids, filtered by the soil.")

(defchemistry colloids default
  (trace colloid); colloid-filtered)
  (reaction ;;(filter (mobile colloid) (immobile colloid-filtered))
            (MACRO (colloid colloid))))


;; Weather data.
(weather default "taastrup.dwf")

;; We have some very sandy soil.
(defhorizon Ap FAO3
  "Andeby top soil."
  (secondary_domain none)
  ;;(mobile_solute mixed
  ;;               (h_lim -20 [cm])
  ;;               (alpha 0.001 [h^-1]))
  (clay 8.0 [%])
  (silt 10.5 [%])
  (sand 81.5 [%])
  (humus 1.12 [%])
  (C_per_N 11.0 [g C/g N])
  (dry_bulk_density 1.5 [g/cm^3]))

(defhorizon C Ap
  "Andeby C horizon."
  ;;(mobile_solute full)
  (secondary_domain pressure
                    (h_lim -20 [cm])
                    (alpha 0.001 [h^-1]))
  (humus 0.12 [%]))

;; We build the column from the horizons.
(defcolumn Andeby default
  "The B.And farm, Andeby, 2002."
  (Soil (horizons (-20 [cm] Ap) (-2.5 [m] C))
        (MaxRootingDepth 60.0 [cm]))
  (Chemistry original (combine &old colloids))
  (Movement original 
            (Tertiary (biopores (use_small_timesteps false)
                                (classes (matrix (height_start 0 [cm])
                                                 (height_end -2 [m])
                                                 ;;(debug 1)
                                                 (density 200 [m^-2])
                                                 (diameter 10 [mm])
                                                 (R_primary 100 [h])
                                                 (R_secondary 10 [h]))
                                         (drain  (height_start -5 [cm])
                                                 (height_end -1.5 [m])
                                                 (diameter 10 [mm])
                                                 (density 100 [m^-2])
                                                 (pipe_position -150 [cm]))
                                         ))))
                             
  (OrganicMatter original
                 (init (input 1400 [kg C/ha/y])
                       (root 480 [kg C/ha/y])
                       (end -20 [cm])))
  ;; Measured numbers for groundwater table can be read from a file, like this:
  ;; (Groundwater file "example.gwt")
  ;; But here we assume free drainage.
  (Groundwater deep))

;; Use it.
(column Andeby)

;; Simulation start date.
(time 1986 12 1 1)

(manager activity
  (wait (at 1987 3 20 1))
  (plowing)
  (wait (at 1987 4 4 1))
  (fertilize (mineral (weight 100.0 [kg N/ha])
                      (NH4_fraction 0.5 [])))
  (wait (at 1987 4 5 1))
  (progn
    (sow ("Grass"
          (water_stress_effect none)
          (enable_N_stress false)))
    (sow ("Spring Barley" (Canopy (EpFac 1.5)))))
  (wait (or (crop_ds_after "Spring Barley" 2.0)
            (at 1987 9 5 1)))
  (harvest "Spring Barley")
  (wait (at 1987 9 8 1))
  (fertilize (mineral (weight 80.0 [kg N/ha])
                      (NH4_fraction 0.5 [])))
  (wait (at 1987 10 10 1))
  (harvest "Grass"
           (stub 8.0 [cm])              ;Leave 8 cm stub.
           (stem 1.00 []))             ;Harvest everything above stub.
  (wait (at 1988 4 1 1))
  (stop))

;; Create these log files.
(output harvest
        "Tertiary biopores water" "Tertiary water sink"
        ("Soil water" (to -1 [m])) ("Field water")
        ("Crop Production" (crop "Spring Barley") (where "sbarley.dlf"))
        ("Field chemical" (chemical colloid))
        ("Soil chemical" (chemical colloid-filtered))
        ("Colloids")
        (checkpoint (when (at 1987 8 7 6))))

;;; test-mibsol.dai ends here.
