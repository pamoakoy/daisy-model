;;; test.dai -- Sample file using the Daisy libraries.

;; We try to run the same simulation with two different soil water
;; transport models.

;; Use standard parameterizations.
(input file "tillage.dai")
(input file "crop.dai")
(input file "log.dai")

;; Weather data.
(weather file "weather.clm"
  (DryDeposit (NO3 1.1)			;[kg/ha/year]
	      (NH4 2.2))
  (WetDeposit (NO3 0.6)			;[ppm]
	      (NH4 0.9)))

;; We have some very sandy soil.
(defhorizon top default
  (hydraulic M_vG 
	     (K_sat 19.3)
	     (Theta_res 0.05)
	     (Theta_sat 0.424)
	     (alpha 0.069)
	     (n 1.527))
  (SOM_fractions 0.66 0.34)
  (SOM_C_per_N 11 11)
  (clay 8.0)
  (silt 10.5)
  (humus 1.12)
  (coarse_sand 63.4)
  (fine_sand 16.5))

(defhorizon bottom default
  (hydraulic M_vG 
	     (K_sat 64.08)
	     (Theta_res 0.042)
	     (Theta_sat 0.438)
	     (alpha 0.054)
	     (n 2.416))
  (SOM_fractions 0.66 0.34)
  (SOM_C_per_N 11 11)
  (clay 8.0)
  (silt 10.5)
  (humus 0.12)				;Less humus here.
  (coarse_sand 63.4)
  (fine_sand 16.5))

;; We use this column.
(defcolumn JB1_Andeby default
  (Bioclimate default)
  (Groundwater static)
  (Soil (horizons (-20 top) (-250 bottom))
	(zplus -2.5 -5 -10 -15 -20
	       -25 -30 -40 -50 -60 -70
	       -80 -90 -100 -125 -150 -175
	       -200 -225 -250)
	(MaxRootingDepth 60.0)
	(dispersivity 8.0))
  (SoilWater (h -100.0))
  (SoilNH4 (M 0.5e-6))
  (SoilNO3 (M 3.0e-6))
  (OrganicMatter (initial_SOM   (-20  4.86)
                                (-40  2.92)
                                (-60  1.46)
                                (-80  0.49)
                                (-100 0.16)
                                (-120 0.03))))



;; We specialize the JB1_Andeby column to use Richards
;; equation and linked reservoirs for water transport, respectively.  
(defcolumn JB1_Richards JB1_Andeby
  (SoilWater (UZtop richards)))

(defcolumn JB1_lr JB1_Andeby
  (SoilWater (UZtop lr)))

;; Run simulation with both columns for comparison.
(column JB1_Richards)

;; Simulation start date.
(time 1986 12 1 1)

;; Our standard fertilizer.
(defam n50 mineral
  (NH4_fraction 0.5))

;; Grass cut strategy.
(defaction cut_grass activity
  (wait (or (crop_ds_after "Grass" 0.7)
	    (crop_dm_over "Grass" 4000)))
  (harvest  "Grass" 
	    (stub 10.0)			;15 cm stub
	    (stem 1.0)))

(defaction cut_grass_fertilize activity
  (cut_grass)
  (wait_days 1)
  (fertilize n50 (weight 100.0)))	;kg N/ha

;; Irrigation strategy.
(defaction irrigate_30 progn
  (if (and (after_mm_dd 5 1)
	   (before_mm_dd 9 1)
	   (not (soil_water_pressure_above (height -30.0)
					   (potential -1000))))
      (irrigate_top 30)))

;; Spring Barley with ley setup.
(defaction sbarley_with_ley activity
  (wait_mm_dd 3 20)
  (plowing)
  (wait_mm_dd 4 10)
  (fertilize n50 (weight 100.0))		;kg N/ha
  (wait_mm_dd 4 15)
  (seed_bed_preparation)
  (progn 
   (sow "Spring Barley")
   (sow "Grass"))
  (wait (or (crop_ds_after "Spring Barley" 2.0)	;Ripe
	    (mm_dd 10 1)))
  (harvest "Spring Barley")
  (wait_days 10)
  (fertilize n50 (weight 100.0))	;kg N/ha
  (while (wait_mm_dd 11 1)
    (if (or (crop_ds_after "Grass" 0.7)
	    (crop_dm_over "Grass" 5000))	;kg DM/ha
	(harvest "Grass" 
		 (stub 15.0)		;15 cm stub
		 (stem 1.0))))
  (wait_mm_dd 4 15)
  (fertilize n50 (weight 100.0))	;kg N/ha
  (while (wait_mm_dd 9 1)
    ;; Max 5 cuts.
    (activity cut_grass_fertilize cut_grass_fertilize cut_grass_fertilize
	      cut_grass_fertilize cut_grass_fertilize))
  (while (wait_mm_dd 11 1)
    ;; Max 3 cuts.
    (activity cut_grass cut_grass cut_grass)))

(manager activity
  (while (sbarley_with_ley)
    (irrigate_30))
  (wait_mm_dd 4 1 )
  (stop))

;; (manager cond 
;;   ((at 1987 3 20 1)
;;    (plowing))
;;   ((at 1987 4 4 1)
;;   (fertilize mineral 
;; 		(weight 100.0)		;kg N/ha
;; 		(NH4_fraction 0.5)))
;;   ((at 1987 4 5 1)
;;    (sow "Cut Grass")
;;    (sow "Spring Barley"))
;;   ((at 1987 9 5 1)
;;    (harvest "Spring Barley")
;;    (harvest "Cut Grass"
;; 	       (stub 15)			;Leave 15 cm stub.
;; 	       (stem 1.00)))		;Harvest everything above stub.
;;   ((at 1987 9 8 1)
;;    (fertilize mineral
;; 		 (weight 80.0)
;; 		 (NH4_fraction 0.5)))
;;   ((at 1987 10 10 1)
;;    (harvest "Cut Grass"
;; 	       (stub 8.)			;Leave 08 cm stub.
;; 	       (stem 1.00)))		;Harvest everything above stub.
;;   ((at 1988 4 1 1)
;;    (stop)))
;; 

(deflog "pond" table1
  (where "pond.tab")
  (when hourly)
  (entries ((path time year))
	   ((path time month))
	   ((path time mday))
	   ((path column "*" Surface pond)
	    (dimension "mm"))))

;; Create these log files.
(output pond Harvest "Grass Production" "Barley Production")

;;; test.dai ends here.
